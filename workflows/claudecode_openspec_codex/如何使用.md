## 流程

### 初始配置

#### openspec

首先是安装Claude code和codex，这个就不列举了。安装openspec这里要说一下，最好是0.21.0版本，因为再新的版本，openspec的工作流重构了，支持自然语言调用，使用的是`skills`触发，后续我也会尝试适配更新最新版本的openspec。

```shell
npm install -g @fission-ai/openspec@0.21.0
```

先使用openspec初始化一下项目

```shell
openspec init
```

```txt
下一步操作 - 将这些提示复制到codex：
────────────────────────────────────────────────────────────
1. 填充项目上下文：
请阅读 openspec/project.md 并协助我完成内容填写
包含我的项目详情、技术栈及规范"

2. 创建您的首个变更提案：
我想添加[在此处填写您的功能]。请创建一个
OpenSpec 对此功能的变更提案

3. 学习 OpenSpec 工作流：
请解释来自 openspec/AGENTS.md 的 OpenSpec 工作流。
以及我该如何与你共同推进这个项目
```

#### Skills和mcp配置

**1. 配置 MCP** 

如果你的任务涉及 GUI（或者 MIXED），我强烈建议加 playwright-mcp。因为我们想做到的是：Supervisor 不靠手动点页面，也不靠脚本跑 Playwright，而是通过 MCP 驱动浏览器并采集证据（截图、日志等）。

playwright-mcp：

```cmd
claude mcp add --transport stdio --scope user playwright-mcp -- npx -y @playwright/mcp@latest
```

再配一个 context7（遇到卡点能查资料、补上下文）：

```cmd
claude mcp add context7 -- npx -y @upstash/context7-mcp@latest
```

我这里浏览器搜索 MCP 用的是智普的（你也可以换别家的，只要名字对得上就行）：

```cmd
claude mcp add -s user -t http web-search-prime https://open.bigmodel.cn/api/mcp/web_search_prime/mcp --header "Authorization: Bearer your_api_key"
```

```cmd
claude mcp add -s user -t http web-reader https://open.bigmodel.cn/api/mcp/web_reader/mcp --header "Authorization: Bearer your_api_key"
```

[配置示例](#自定义skills-mcp)

**2. skills**

这几个 skill 我是直接放在仓库里维护的：

给 `codex` 用的：

- 建议大家去 [GitHub 下载 openspec-change-interviewer](https://github.com/Rosetears520/aili-notes/tree/main/skills/openspec-change-interviewer)（用 **采访式反问** 把需求对齐）
- 再去 [GitHub 下载 openspec-feature-list](https://github.com/Rosetears520/aili-notes/tree/main/skills/openspec-feature-list)（生成 `feature_list.json` ）

给 `Claude Code` 用的：

- 这个是 Supervisor 卡点用的研究：建议大家去 [GitHub 下载 openspec-unblock-research](https://github.com/Rosetears520/aili-notes/tree/main/skills/openspec-unblock-research)

<a id="自定义skills-mcp"></a>

**自定义 openspec-unblock-research 的 mcp server**
1. 配置mcp server

在 Claude Code 中运行 `mcp list`。必须看到 `mcp__<new-search-name>__*` 和 `mcp__github__*` (或其他辅助工具) 均已加载。

2. 修改核心文件 (`SKILL.md`)

对 `openspec-unblock-research` 的 `SKILL.md` 进行两处关键修改：

- 修改文件头部 Description
	保持描述与实际工具一致。
	- 把 `mcp__web-search-prime__*`
	- 改为 `mcp__<new-search-name>__*`
	
- 修改 Default Provider Ordering
	在文件底部的列表里 **插入新工具** 并 **替换旧搜索**。

**修改示例：**

```markdown
## Default provider ordering (if caller omits toolchain_config)

1. `mcp__context7__*` (authority source)
   ...

2. `mcp__github__*` (新增: internal authority)
   - Use for: checking existing issues/bugs in repo or upstream.
   - Trigger when: `error_excerpt` looks like a library bug.
   - Stop when: found a closed issue matching symptoms.

3. `mcp__<new-search-name>__*` (替换原有的 search-prime)
   - Use for: recent regressions, common pitfalls.
   - Trigger when: `error_excerpt` includes searchable strings.
   - Stop when: have candidate links to verify.

4. `mcp__web-reader__*` (evidence fetcher)
   ...
```


---

### 需要更改的文件

#### 关键文件修改

为了让这套流程跑起来，我们需要覆盖或新建几个配置文件。

具体内容见同名文件

##### openspec-proposal.md需要添加的

**位置：**

- Windows: `%USERPROFILE%\.codex\prompts\openspec-proposal.md`
- macOS/Linux: `~/.codex/prompts/openspec-proposal.md`

目的：让openspec生成的task.md比较符合我们的需求。

> 注：该文件必须在输入`openspec init`后修改，否则会默认重置掉。

**Steps**6后面添加


##### 项目目录：openspec\project.md

目的：让openspec生成的task.md比较符合我们的需求。

在project.md末尾添加

##### 项目目录：.\claude.md

目的：明确Claude code的任务身份、工作流。

完全覆盖`claude.md`

##### `.claude/commands/monitor-openspec-codex.md` (自动化核心)

在
- Windows: `%USERPROFILE%\.claude\commands`
- macOS/Linux: `~/.claude/commands`
下新建：`monitor-openspec-codex.md`

这是我们的“监工脚本”，它定义了 Claude Code 如何自动循环调用 Codex。

新建`monitor-openspec-codex.md`

### 重复流程

先打开codex，使用自然语言提出一个变更提案，例如：`为我这个项目添加一个支持夜间模型自动切换的功能`

然后再使用skills`$openspec-change-interviewer <id>`让模型通过采访的方式，明确我们的需求，对齐需求。<id>填写的是openspec文件夹下的当前提案的文件夹名称。

再 `$openspec-feature-list <id>` 让模型列出来一个feature_list.json。

最后打开Claude code，输入`/monitor-openspec-codex <id>`即可

> `<id>` 就是 `openspec` 文件夹下当前提案的文件夹名
